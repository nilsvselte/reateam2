<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Model Evaluations</title>
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "IBM Plex Sans", sans-serif;
        background: #fff;
        color: #111;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .subtitle {
        color: #666;
        font-size: 0.9rem;
      }

      .stats {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        font-size: 0.85rem;
        color: #666;
      }

      .stats strong {
        color: #111;
        font-weight: 600;
      }

      .controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }

      .search-box {
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .search-box input {
        width: 100%;
        padding: 0.6rem 0.75rem 0.6rem 2.25rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.9rem;
      }

      .search-box input:focus {
        outline: none;
        border-color: #111;
      }

      .search-box::before {
        content: "⌕";
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 1rem;
      }

      select {
        padding: 0.6rem 0.75rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.9rem;
        background: #fff;
        cursor: pointer;
      }

      select:focus {
        outline: none;
        border-color: #111;
      }

      .view-toggle {
        display: flex;
        border: 1px solid #ccc;
        border-radius: 4px;
        overflow: hidden;
      }

      .view-toggle button {
        padding: 0.6rem 1rem;
        border: none;
        background: #fff;
        font-family: inherit;
        font-size: 0.9rem;
        cursor: pointer;
        color: #666;
      }

      .view-toggle button.active {
        background: #111;
        color: #fff;
      }

      .section {
        margin-bottom: 1.5rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
        user-select: none;
      }

      .section-header:hover {
        background: #fafafa;
      }

      .section-toggle {
        font-size: 0.7rem;
        color: #999;
        transition: transform 0.15s;
      }

      .section.collapsed .section-toggle {
        transform: rotate(-90deg);
      }

      .section-label {
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.75rem;
        background: #111;
        color: #fff;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
      }

      .section-title {
        flex: 1;
        font-weight: 500;
      }

      .section-count {
        font-size: 0.8rem;
        color: #888;
      }

      .section-body {
        border-top: 1px solid #e0e0e0;
      }

      .section.collapsed .section-body {
        display: none;
      }

      .summary-box {
        padding: 1rem;
        background: #f8f8f8;
        font-size: 0.85rem;
        line-height: 1.7;
      }

      .summary-box strong {
        font-weight: 600;
      }

      .summary-strengths {
        color: #2d7a2d;
      }

      .summary-weaknesses {
        color: #a33;
      }

      .model-group {
        border-top: 1px solid #e0e0e0;
      }

      .model-group:first-child {
        border-top: none;
      }

      .model-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .model-header:hover {
        background: #fafafa;
      }

      .model-toggle {
        font-size: 0.65rem;
        color: #bbb;
        transition: transform 0.15s;
      }

      .model-group.collapsed .model-toggle {
        transform: rotate(-90deg);
      }

      .model-name {
        flex: 1;
        font-weight: 500;
      }

      .model-count {
        font-size: 0.8rem;
        color: #888;
        font-family: "IBM Plex Mono", monospace;
      }

      .posts-container {
        background: #fafafa;
      }

      .model-group.collapsed .posts-container {
        display: none;
      }

      .post {
        padding: 0.75rem 1rem;
        border-top: 1px solid #eee;
      }

      .post:first-child {
        border-top: none;
      }

      .post-title {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .post-title a {
        color: inherit;
        text-decoration: none;
      }

      .post-title a:hover {
        text-decoration: underline;
      }

      .post-meta {
        font-size: 0.8rem;
        color: #888;
        margin-bottom: 0.5rem;
      }

      .post-version {
        font-family: "IBM Plex Mono", monospace;
        background: #eee;
        padding: 0.1rem 0.35rem;
        border-radius: 2px;
        font-size: 0.75rem;
      }

      .post-content {
        font-size: 0.85rem;
        color: #444;
        line-height: 1.7;
      }

      .post-content.truncated {
        max-height: 100px;
        overflow: hidden;
        position: relative;
      }

      .post-content.truncated::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: linear-gradient(transparent, #fafafa);
      }

      .expand-btn {
        background: none;
        border: none;
        color: #111;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.8rem;
        padding: 0.25rem 0;
        text-decoration: underline;
      }

      .empty {
        text-align: center;
        padding: 3rem;
        color: #888;
      }

      .loading {
        text-align: center;
        padding: 4rem;
        color: #888;
      }

      .no-content {
        color: #999;
        font-style: italic;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>AI Model Evaluations</h1>
        <p class="subtitle">Deep learning homework performance analysis</p>
        <div class="stats">
          <span><strong id="total-posts">-</strong> evaluations</span>
          <span><strong id="total-models">-</strong> models</span>
          <span><strong id="total-hw">-</strong> assignments</span>
        </div>
      </header>

      <div class="controls">
        <div class="search-box">
          <input type="text" id="search" placeholder="Search posts..." />
        </div>
        <select id="hw-filter">
          <option value="all">All HW</option>
        </select>
        <select id="model-filter">
          <option value="all">All Models</option>
        </select>
        <div class="view-toggle">
          <button class="active" data-view="hw">By HW</button>
          <button data-view="model">By Model</button>
        </div>
      </div>

      <main id="content">
        <div class="loading">Loading...</div>
      </main>
    </div>

    <script>
      function parseCSV(text) {
        const lines = text.split("\n");
        const headers = parseCSVLine(lines[0]);
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim() === "") continue;
          const values = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((h, idx) => (row[h] = values[idx] || ""));
          data.push(row);
        }
        return data;
      }

      function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            result.push(current);
            current = "";
          } else {
            current += char;
          }
        }
        result.push(current);
        return result;
      }

      function analyzePosts(posts) {
        const strengthTerms = {
          "one-shot": "solved problems in one attempt",
          correct: "produced correct answers",
          accurate: "gave accurate responses",
          impressive: "showed impressive reasoning",
          strong: "demonstrated strong understanding",
          excellent: "excellent performance",
          perfect: "achieved perfect scores",
          elegant: "provided elegant solutions",
          intuitive: "gave intuitive explanations",
          thorough: "was thorough in analysis",
        };

        const weaknessTerms = {
          hallucination: "hallucinated information",
          struggled: "struggled with some problems",
          failed: "failed on certain tasks",
          incorrect: "gave incorrect answers",
          wrong: "made errors",
          mistake: "made mistakes",
          skipped: "skipped steps in reasoning",
          missing: "missing key details",
          confused: "showed confusion",
        };

        const strengths = new Set();
        const weaknesses = new Set();

        posts.forEach((post) => {
          const text = (post.text || "").toLowerCase();
          for (const [term, desc] of Object.entries(strengthTerms)) {
            if (text.includes(term)) strengths.add(desc);
          }
          for (const [term, desc] of Object.entries(weaknessTerms)) {
            if (text.includes(term)) weaknesses.add(desc);
          }
        });

        return {
          strengths: [...strengths].slice(0, 3),
          weaknesses: [...weaknesses].slice(0, 3),
        };
      }

      function generateSummary(posts, groupName) {
        const analysis = analyzePosts(posts);
        const models = [
          ...new Set(posts.map((p) => p.base_model).filter(Boolean)),
        ];

        let html = `<strong>${posts.length}</strong> evaluation${
          posts.length !== 1 ? "s" : ""
        } from <strong>${models.length}</strong> model${
          models.length !== 1 ? "s" : ""
        }.`;

        if (analysis.strengths.length > 0) {
          html += ` <span class="summary-strengths"><strong>Strengths:</strong> ${analysis.strengths.join(
            ", "
          )}.</span>`;
        }

        if (analysis.weaknesses.length > 0) {
          html += ` <span class="summary-weaknesses"><strong>Weaknesses:</strong> ${analysis.weaknesses.join(
            ", "
          )}.</span>`;
        }

        if (
          analysis.strengths.length === 0 &&
          analysis.weaknesses.length === 0
        ) {
          html += " No detailed analysis available from post content.";
        }

        return html;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function renderPost(post, index) {
        const hasContent = post.text && post.text.trim().length > 0;
        const contentId = `post-${post.thread_id}-${index}`;

        return `
        <div class="post">
          <div class="post-title">
            ${
              post.url
                ? `<a href="${post.url}" target="_blank">${
                    post.title_clean || "Untitled"
                  }</a>`
                : post.title_clean || "Untitled"
            }
          </div>
          <div class="post-meta">
            ${post.name || "Anonymous"}
            ${
              post.version
                ? `<span class="post-version">${post.version}</span>`
                : ""
            }
          </div>
          ${
            hasContent
              ? `
            <div class="post-content truncated" id="${contentId}">${escapeHtml(
                  post.text
                )}</div>
            <button class="expand-btn" onclick="togglePost('${contentId}', this)">Show more</button>
          `
              : '<p class="no-content">No detailed content</p>'
          }
        </div>
      `;
      }

      function renderByHomework(data, hwFilter, modelFilter, searchTerm) {
        let filtered = data.filter(
          (d) => d.hw_number && d.hw_number.match(/^\d+$/)
        );
        if (hwFilter !== "all")
          filtered = filtered.filter((d) => d.hw_number === hwFilter);
        if (modelFilter !== "all")
          filtered = filtered.filter((d) => d.base_model === modelFilter);
        if (searchTerm) {
          const term = searchTerm.toLowerCase();
          filtered = filtered.filter(
            (d) =>
              (d.title_clean || "").toLowerCase().includes(term) ||
              (d.text || "").toLowerCase().includes(term) ||
              (d.name || "").toLowerCase().includes(term) ||
              (d.model || "").toLowerCase().includes(term)
          );
        }

        const hwGroups = {};
        filtered.forEach((post) => {
          const hw = post.hw_number;
          if (!hwGroups[hw]) hwGroups[hw] = [];
          hwGroups[hw].push(post);
        });

        if (Object.keys(hwGroups).length === 0) {
          return '<div class="empty">No posts found</div>';
        }

        const sortedHWs = Object.keys(hwGroups).sort(
          (a, b) => parseInt(a) - parseInt(b)
        );

        return sortedHWs
          .map((hw) => {
            const posts = hwGroups[hw];
            const modelGroups = {};
            posts.forEach((post) => {
              const model = post.base_model || "Unknown";
              if (!modelGroups[model]) modelGroups[model] = [];
              modelGroups[model].push(post);
            });

            const summary = generateSummary(posts, `HW ${hw}`);

            return `
          <div class="section" id="hw-${hw}">
            <div class="section-header" onclick="toggleSection('hw-${hw}')">
              <span class="section-toggle">▼</span>
              <span class="section-label">HW ${hw}</span>
              <span class="section-title">Homework ${hw}</span>
              <span class="section-count">${posts.length}</span>
            </div>
            <div class="section-body">
              <div class="summary-box">${summary}</div>
              ${Object.entries(modelGroups)
                .sort((a, b) => b[1].length - a[1].length)
                .map(
                  ([model, modelPosts], idx) => `
                  <div class="model-group" id="hw-${hw}-model-${idx}">
                    <div class="model-header" onclick="toggleModelGroup('hw-${hw}-model-${idx}')">
                      <span class="model-toggle">▼</span>
                      <span class="model-name">${model}</span>
                      <span class="model-count">${modelPosts.length}</span>
                    </div>
                    <div class="posts-container">
                      ${modelPosts
                        .map((post, i) => renderPost(post, `${hw}-${idx}-${i}`))
                        .join("")}
                    </div>
                  </div>
                `
                )
                .join("")}
            </div>
          </div>
        `;
          })
          .join("");
      }

      function renderByModel(data, hwFilter, modelFilter, searchTerm) {
        let filtered = data.filter(
          (d) => d.hw_number && d.hw_number.match(/^\d+$/)
        );
        if (hwFilter !== "all")
          filtered = filtered.filter((d) => d.hw_number === hwFilter);
        if (modelFilter !== "all")
          filtered = filtered.filter((d) => d.base_model === modelFilter);
        if (searchTerm) {
          const term = searchTerm.toLowerCase();
          filtered = filtered.filter(
            (d) =>
              (d.title_clean || "").toLowerCase().includes(term) ||
              (d.text || "").toLowerCase().includes(term) ||
              (d.name || "").toLowerCase().includes(term) ||
              (d.model || "").toLowerCase().includes(term)
          );
        }

        const modelGroups = {};
        filtered.forEach((post) => {
          const model = post.base_model || "Unknown";
          if (!modelGroups[model]) modelGroups[model] = [];
          modelGroups[model].push(post);
        });

        if (Object.keys(modelGroups).length === 0) {
          return '<div class="empty">No posts found</div>';
        }

        const sortedModels = Object.entries(modelGroups).sort(
          (a, b) => b[1].length - a[1].length
        );

        return sortedModels
          .map(([model, posts], modelIdx) => {
            const hwGroups = {};
            posts.forEach((post) => {
              const hw = post.hw_number;
              if (!hwGroups[hw]) hwGroups[hw] = [];
              hwGroups[hw].push(post);
            });

            const summary = generateSummary(posts, model);

            return `
          <div class="section" id="model-${modelIdx}">
            <div class="section-header" onclick="toggleSection('model-${modelIdx}')">
              <span class="section-toggle">▼</span>
              <span class="section-label">${posts.length}</span>
              <span class="section-title">${model}</span>
              <span class="section-count">${
                Object.keys(hwGroups).length
              } HW</span>
            </div>
            <div class="section-body">
              <div class="summary-box">${summary}</div>
              ${Object.entries(hwGroups)
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
                .map(
                  ([hw, hwPosts], idx) => `
                  <div class="model-group" id="model-${modelIdx}-hw-${idx}">
                    <div class="model-header" onclick="toggleModelGroup('model-${modelIdx}-hw-${idx}')">
                      <span class="model-toggle">▼</span>
                      <span class="model-name">Homework ${hw}</span>
                      <span class="model-count">${hwPosts.length}</span>
                    </div>
                    <div class="posts-container">
                      ${hwPosts
                        .map((post, i) =>
                          renderPost(post, `${modelIdx}-${hw}-${i}`)
                        )
                        .join("")}
                    </div>
                  </div>
                `
                )
                .join("")}
            </div>
          </div>
        `;
          })
          .join("");
      }

      function toggleSection(id) {
        document.getElementById(id).classList.toggle("collapsed");
      }

      function toggleModelGroup(id) {
        document.getElementById(id).classList.toggle("collapsed");
      }

      function togglePost(id, btn) {
        const el = document.getElementById(id);
        el.classList.toggle("truncated");
        btn.textContent = el.classList.contains("truncated")
          ? "Show more"
          : "Show less";
      }

      let allData = [];
      let currentView = "hw";

      function render() {
        const hwFilter = document.getElementById("hw-filter").value;
        const modelFilter = document.getElementById("model-filter").value;
        const searchTerm = document.getElementById("search").value.trim();
        const content = document.getElementById("content");

        if (currentView === "hw") {
          content.innerHTML = renderByHomework(
            allData,
            hwFilter,
            modelFilter,
            searchTerm
          );
        } else {
          content.innerHTML = renderByModel(
            allData,
            hwFilter,
            modelFilter,
            searchTerm
          );
        }
      }

      async function init() {
        try {
          const response = await fetch("special_participation_a.csv");
          const text = await response.text();
          allData = parseCSV(text);

          const validData = allData.filter(
            (d) => d.hw_number && d.hw_number.match(/^\d+$/)
          );

          document.getElementById("total-posts").textContent = validData.length;

          const uniqueModels = [
            ...new Set(validData.map((d) => d.base_model).filter(Boolean)),
          ];
          document.getElementById("total-models").textContent =
            uniqueModels.length;

          const uniqueHW = [...new Set(validData.map((d) => d.hw_number))];
          document.getElementById("total-hw").textContent = uniqueHW.length;

          const hwFilter = document.getElementById("hw-filter");
          uniqueHW
            .sort((a, b) => parseInt(a) - parseInt(b))
            .forEach((hw) => {
              const option = document.createElement("option");
              option.value = hw;
              option.textContent = `HW ${hw}`;
              hwFilter.appendChild(option);
            });

          const modelFilter = document.getElementById("model-filter");
          uniqueModels.sort().forEach((model) => {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            modelFilter.appendChild(option);
          });

          hwFilter.addEventListener("change", render);
          modelFilter.addEventListener("change", render);

          document.getElementById("search").addEventListener("input", render);

          document.querySelectorAll(".view-toggle button").forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".view-toggle button")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
              currentView = btn.dataset.view;
              render();
            });
          });

          render();
        } catch (error) {
          document.getElementById(
            "content"
          ).innerHTML = `<div class="empty">Error: ${error.message}</div>`;
        }
      }

      init();
    </script>
  </body>
</html>
